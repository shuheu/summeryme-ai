name: ğŸš€ [Deploy] Infrastructure with Terraform

on:
  push:
    branches:
      - main
      - 'feat/**' # TODO: testç”¨
    paths:
      - 'terraform/**'
      - '.github/workflows/deploy-infrastructure.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'terraform/**'
      - '.github/workflows/deploy-infrastructure.yml'
  workflow_dispatch:
    inputs:
      action:
        description: 'Terraform action to perform'
        required: true
        default: 'plan'
        type: choice
        options:
          - plan
          - apply
          - destroy
      target:
        description: 'Terraform target (optional)'
        required: false
        type: string

env:
  PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  REGION: ${{ vars.GCP_REGION || 'asia-northeast1' }}
  TERRAFORM_VERSION: 1.6.0
  BACKEND_PREFIX: summeryme-ai/backend

jobs:
  terraform:
    name: Terraform ${{ github.event.inputs.action || 'plan' }}
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./terraform

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Create terraform.tfvars
        run: |
          cat > terraform.tfvars << EOF
          project_id      = "${{ env.PROJECT_ID }}"
          region          = "${{ env.REGION }}"
          environment     = "production"
          container_image = "${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/backend/backend-api:latest"
          EOF

      - name: Terraform Init
        run: |
          echo "ğŸ”§ Initializing Terraform with GCS backend..."
          echo "Backend bucket: ${{ env.PROJECT_ID }}-terraform-state"
          echo "Backend prefix: ${{ env.BACKEND_PREFIX }}"

          # GCSãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§Terraformã‚’åˆæœŸåŒ–
          terraform init \
            -backend-config="bucket=${{ env.PROJECT_ID }}-terraform-state" \
            -backend-config="prefix=${{ env.BACKEND_PREFIX }}"

          echo "âœ… Terraform initialized with GCS backend"

      - name: ğŸ” Setup and Run TFLint
        continue-on-error: true
        run: |
          echo "ğŸ”§ Setting up TFLint..."
          curl -s https://raw.githubusercontent.com/terraform-linters/tflint/master/install_linux.sh | bash

          echo "ğŸ” Running TFLint..."
          tflint --init
          tflint --recursive || echo "âš ï¸ TFLint found issues (continuing for hackathon)"

          echo "âœ… TFLint checks completed!"

      - name: ğŸ”’ Setup and Run tfsec
        continue-on-error: true
        run: |
          echo "ğŸ”§ Setting up tfsec..."
          curl -s https://raw.githubusercontent.com/aquasecurity/tfsec/master/scripts/install_linux.sh | bash

          echo "ğŸ”’ Running security scan..."
          tfsec . --tfvars-file terraform.tfvars --format lovely || echo "âš ï¸ tfsec found security issues (continuing for hackathon)"

          echo "âœ… Security scan completed!"

      - name: ğŸ“‹ Setup and Run Checkov
        continue-on-error: true
        run: |
          echo "ğŸ”§ Setting up Checkov..."
          pip install checkov

          echo "ğŸ“‹ Running Checkov compliance checks..."
          checkov -d . --framework terraform --quiet || echo "âš ï¸ Checkov found compliance issues (continuing for hackathon)"

          echo "âœ… Compliance checks completed!"

      - name: Terraform Validate
        run: |
          echo "âœ… Validating Terraform configuration..."
          terraform validate

      - name: Terraform Format Check
        run: |
          echo "ğŸ“ Checking Terraform formatting..."
          terraform fmt -check

      - name: Terraform Plan
        if: ${{ github.event.inputs.action == 'plan' || github.event.inputs.action == '' }}
        run: |
          echo "ğŸ“‹ Running Terraform plan..."
          if [ -n "${{ github.event.inputs.target }}" ]; then
            terraform plan -target="${{ github.event.inputs.target }}"
          else
            terraform plan
          fi

      - name: Terraform Apply
        if: ${{ github.event.inputs.action == 'apply' }}
        run: |
          echo "ğŸš€ Applying Terraform changes..."
          if [ -n "${{ github.event.inputs.target }}" ]; then
            terraform apply -auto-approve -target="${{ github.event.inputs.target }}"
          else
            terraform apply -auto-approve
          fi

      - name: Terraform Destroy
        if: ${{ github.event.inputs.action == 'destroy' }}
        run: |
          echo "ğŸ—‘ï¸ Destroying Terraform resources..."
          echo "âš ï¸ WARNING: This will destroy infrastructure!"
          if [ -n "${{ github.event.inputs.target }}" ]; then
            terraform destroy -auto-approve -target="${{ github.event.inputs.target }}"
          else
            terraform destroy -auto-approve
          fi

      - name: Terraform Output
        if: ${{ github.event.inputs.action == 'apply' }}
        run: |
          echo "ğŸ“Š Terraform outputs:"
          terraform output

      - name: ğŸ“Š Upload Security Scan Results
        if: false # always()
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-results
          path: |
            terraform/tfsec-results.json
            terraform/checkov-results.json
          retention-days: 30
