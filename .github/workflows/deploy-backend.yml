name: ğŸš€ [Deploy] Backend to Cloud Run

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      run_migration:
        description: 'Run database migration after deployment'
        required: false
        default: true
        type: boolean

env:
  PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  REGION: ${{ vars.GCP_REGION || 'asia-northeast1' }}
  SERVICE_NAME: ${{ vars.GCP_SERVICE_NAME || 'backend-api' }}
  BACKEND_PREFIX: summeryme-ai/backend

jobs:
  deploy:
    name: Deploy to Cloud Run
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend_ts

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate required variables
        run: |
          if [ -z "${{ env.PROJECT_ID }}" ]; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: GCP_PROJECT_IDå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
            echo "GitHub ãƒªãƒã‚¸ãƒˆãƒªã® Variables ã§ GCP_PROJECT_ID ã‚’è¨­å®šã—ã¦ãã ã•ã„"
            exit 1
          fi
          echo "âœ… PROJECT_ID: ${{ env.PROJECT_ID }}"
          echo "âœ… REGION: ${{ env.REGION }}"
          echo "âœ… SERVICE_NAME: ${{ env.SERVICE_NAME }}"

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Configure gcloud project
        run: |
          gcloud config set project ${{ env.PROJECT_ID }}
          echo "âœ… gcloud project set to: $(gcloud config get-value project)"

      - name: Configure Docker for Artifact Registry
        run: |
          echo "ğŸ”§ Configuring Docker for Artifact Registry..."
          echo "PROJECT_ID: ${{ env.PROJECT_ID }}"
          echo "REGION: ${{ env.REGION }}"

          # å¤‰æ•°ã®æ¤œè¨¼
          if [ -z "${{ env.REGION }}" ]; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: REGIONå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
            exit 1
          fi

          REGISTRY_URL="${{ env.REGION }}-docker.pkg.dev"
          echo "Registry URL: ${REGISTRY_URL}"

          # Artifact Registryã®èªè¨¼è¨­å®š
          gcloud auth configure-docker "${REGISTRY_URL}" --quiet

          # è¨­å®šã®ç¢ºèª
          if gcloud auth list --filter="status:ACTIVE" --format="value(account)" | head -1 >/dev/null; then
            echo "âœ… Docker configured for Artifact Registry"
          else
            echo "âŒ ã‚¨ãƒ©ãƒ¼: Dockerèªè¨¼è¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          fi

      - name: Verify Artifact Registry repository
        run: |
          if ! gcloud artifacts repositories describe backend --location=${{ env.REGION }} --project=${{ env.PROJECT_ID }} >/dev/null 2>&1; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: Artifact Registryãƒªãƒã‚¸ãƒˆãƒª 'backend' ãŒå­˜åœ¨ã—ã¾ã›ã‚“"
            echo "ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ä½œæˆã—ã¦ãã ã•ã„:"
            echo "  gcloud artifacts repositories create backend --repository-format=docker --location=${{ env.REGION }}"
            exit 1
          fi
          echo "âœ… Artifact Registryãƒªãƒã‚¸ãƒˆãƒª 'backend' ãŒå­˜åœ¨ã—ã¾ã™"

      - name: Build Docker image
        run: |
          echo "ğŸ”¨ Building Docker image..."
          echo "PROJECT_ID: ${{ env.PROJECT_ID }}"
          echo "REGION: ${{ env.REGION }}"
          echo "SHA: ${{ github.sha }}"

          # Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰ï¼ˆ1å›ã®ã¿ï¼‰
          docker build -t "${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/backend/backend-api:${{ github.sha }}" .

          # latestã‚¿ã‚°ã‚’è¿½åŠ 
          docker tag "${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/backend/backend-api:${{ github.sha }}" "${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/backend/backend-api:latest"

          echo "âœ… Docker image built successfully with both tags"

      - name: Push Docker image
        run: |
          echo "ğŸ“¤ Pushing Docker images..."

          # Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ—ãƒƒã‚·ãƒ¥
          docker push "${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/backend/backend-api:${{ github.sha }}"
          docker push "${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/backend/backend-api:latest"

          echo "âœ… Docker images pushed successfully"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Deploy with Terraform
        working-directory: ./terraform
        run: |
          # terraform.tfvarsã‚’å‹•çš„ã«ä½œæˆ
          cat > terraform.tfvars << EOF
          project_id      = "${{ env.PROJECT_ID }}"
          region          = "${{ env.REGION }}"
          environment     = "${{ github.event.inputs.environment || 'production' }}"
          container_image = "${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/backend/backend-api:${{ github.sha }}"
          EOF

          # GCSãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§Terraformã‚’åˆæœŸåŒ–
          echo "ğŸ”§ Initializing Terraform with GCS backend..."
          echo "Backend bucket: ${{ env.PROJECT_ID }}-terraform-state"
          echo "Backend prefix: ${{ env.BACKEND_PREFIX }}"

          terraform init \
            -backend-config="bucket=${{ env.PROJECT_ID }}-terraform-state" \
            -backend-config="prefix=${{ env.BACKEND_PREFIX }}"

          # Makeã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¦Cloud Runã‚µãƒ¼ãƒ“ã‚¹ã¨Jobã‚’æ›´æ–°
          make init

          # TerraformåˆæœŸåŒ–ã®ç¢ºèª
          if [ ! -d ".terraform" ]; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: TerraformåˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          fi
          echo "âœ… TerraformåˆæœŸåŒ–å®Œäº†"

          # å¤‰æ›´å†…å®¹ã®ç¢ºèª
          echo "ğŸ” Cloud Runã‚µãƒ¼ãƒ“ã‚¹ã®å¤‰æ›´å†…å®¹ã‚’ç¢ºèªä¸­..."
          make plan-cloud-run

          echo "ğŸ” Cloud Run Jobã®å¤‰æ›´å†…å®¹ã‚’ç¢ºèªä¸­..."
          make plan-cloud-run-job

          # å¤‰æ›´ã®é©ç”¨
          echo "ğŸš€ Cloud Runã‚µãƒ¼ãƒ“ã‚¹ã‚’æ›´æ–°ä¸­..."
          make apply-cloud-run

          echo "ğŸš€ Cloud Run Jobã‚’æ›´æ–°ä¸­..."
          make apply-cloud-run-job

      - name: Verify deployment
        working-directory: ./terraform
        run: |
          # Cloud Runã‚µãƒ¼ãƒ“ã‚¹ã®çŠ¶æ…‹ç¢ºèª
          if ! gcloud run services describe ${{ env.SERVICE_NAME }} --region=${{ env.REGION }} >/dev/null 2>&1; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: Cloud Runã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã«å¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          fi
          echo "âœ… Cloud Runã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸ"

      - name: Run database migration
        if: ${{ github.event.inputs.run_migration == 'true' }}
        working-directory: ./terraform
        run: |
          echo "ğŸ”„ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œä¸­..."
          make migrate

      - name: Get service URL
        id: get-url
        working-directory: ./
        run: |
          URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --format='value(status.url)')
          echo "SERVICE_URL=$URL" >> $GITHUB_OUTPUT
          echo "Service deployed to: $URL"

      - name: Health check
        working-directory: ./
        run: |
          echo "Performing health check..."
          sleep 30  # Wait for service to be ready
          curl -f ${{ steps.get-url.outputs.SERVICE_URL }}/health/basic || exit 1
          echo "Basic health check passed!"
          echo "Testing database health check..."
          curl -f ${{ steps.get-url.outputs.SERVICE_URL }}/health || echo "Database health check failed (this is expected if DB connection issues exist)"
          echo "Health check completed!"

      - name: Deployment summary
        working-directory: ./
        run: |
          echo "ğŸš€ Deployment completed successfully!"
          echo "ğŸ“ Environment: ${{ github.event.inputs.environment }}"
          echo "ğŸŒ Service URL: ${{ steps.get-url.outputs.SERVICE_URL }}"
          echo "ğŸ”„ Migration: ${{ github.event.inputs.run_migration }}"
