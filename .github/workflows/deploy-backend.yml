name: Deploy Backend to Cloud Run

on:
  # TODO: testç”¨
  push:
    branches:
      - 'feat/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      run_migration:
        description: 'Run database migration after deployment'
        required: false
        default: true
        type: boolean

env:
  PROJECT_ID: ${{ vars.GCP_PROJECT_ID || 'numeric-skill-460414-d3' }}
  REGION: ${{ vars.GCP_REGION || 'asia-northeast1' }}
  SERVICE_NAME: ${{ vars.GCP_SERVICE_NAME || 'backend-api' }}
  MIGRATION_JOB_NAME: migrate-job
  CLOUDSQL_INSTANCE: summeryme-db

jobs:
  deploy:
    name: Deploy to Cloud Run
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend_ts

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Set up pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10.11.0

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate Prisma client
        run: pnpm prisma generate

      - name: Run linting
        run: pnpm lint

      - name: Run format check
        run: pnpm format-check

      - name: Build application
        run: pnpm build

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Configure gcloud
        run: |
          gcloud config set project ${{ env.PROJECT_ID }}
          gcloud config set run/region ${{ env.REGION }}

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --source . \
            --platform=managed \
            --allow-unauthenticated \
            --memory=1Gi \
            --cpu=1 \
            --concurrency=100 \
            --min-instances=0 \
            --max-instances=10 \
            --timeout=900 \
            --set-env-vars="NODE_ENV=${{ github.event.inputs.environment }},LOG_LEVEL=info,GOOGLE_CLOUD_PROJECT=${{ env.PROJECT_ID }},GCP_REGION=${{ env.REGION }}" \
        # --set-cloudsql-instances=${{ env.PROJECT_ID }}:${{ env.REGION }}:${{ env.CLOUDSQL_INSTANCE }} \
        # --set-secrets="DB_PASSWORD=db-password:latest" \
        # --set-env-vars="DATABASE_URL=mysql://summeryme_user:\$${DB_PASSWORD}@localhost:3306/summeryme_production?socket=/cloudsql/${{ env.PROJECT_ID }}:${{ env.REGION }}:${{ env.CLOUDSQL_INSTANCE }}"

      - name: Run database migration
        if: ${{ github.event.inputs.run_migration == 'true' }}
        run: |
          echo "Running database migration..."
          gcloud run jobs execute ${{ env.MIGRATION_JOB_NAME }} \
            --region=${{ env.REGION }} \
            --wait

      - name: Get service URL
        id: get-url
        run: |
          URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --format='value(status.url)')
          echo "SERVICE_URL=$URL" >> $GITHUB_OUTPUT
          echo "Service deployed to: $URL"

      - name: Health check
        run: |
          echo "Performing health check..."
          sleep 30  # Wait for service to be ready
          curl -f ${{ steps.get-url.outputs.SERVICE_URL }}/health/basic || exit 1
          echo "Basic health check passed!"
          echo "Testing database health check..."
          curl -f ${{ steps.get-url.outputs.SERVICE_URL }}/health || echo "Database health check failed (this is expected if DB connection issues exist)"
          echo "Health check completed!"

      - name: Deployment summary
        run: |
          echo "ğŸš€ Deployment completed successfully!"
          echo "ğŸ“ Environment: ${{ github.event.inputs.environment }}"
          echo "ğŸŒ Service URL: ${{ steps.get-url.outputs.SERVICE_URL }}"
          echo "ğŸ”„ Migration: ${{ github.event.inputs.run_migration }}"
