# Makefile for Terraform Operations
# Summaryme AI Backend Infrastructure

.PHONY: help init plan apply destroy validate format check check-all clean import output state lint lint-fix checkov checkov-json checkov-quiet security-all

# å‹•çš„ã«GCPãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDã‚’å–å¾—
PROJECT_ID := $(shell gcloud config get-value project 2>/dev/null)
REGION := asia-northeast1

# Terraformãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰è¨­å®š
BACKEND_BUCKET := $(PROJECT_ID)-terraform-state
BACKEND_PREFIX := summeryme-ai/backend

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
check-project:
	@if [ -z "$(PROJECT_ID)" ]; then \
		echo "âŒ ã‚¨ãƒ©ãƒ¼: GCPãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"; \
		echo "ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’è¨­å®šã—ã¦ãã ã•ã„:"; \
		echo "  gcloud config set project YOUR_PROJECT_ID"; \
		exit 1; \
	else \
		echo "âœ… ä½¿ç”¨ä¸­ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $(PROJECT_ID)"; \
	fi

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
help: ## ã“ã®ãƒ˜ãƒ«ãƒ—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
	@echo "Summaryme AI Backend - Terraform Operations"
	@echo ""
	@echo "ç¾åœ¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $(PROJECT_ID)"
	@echo ""
	@echo "åˆ©ç”¨å¯èƒ½ãªã‚³ãƒãƒ³ãƒ‰:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-15s\033[0m %s\n", $$1, $$2}'

# åŸºæœ¬æ“ä½œ
init: check-project ## Terraformã‚’åˆæœŸåŒ–
	@echo "ğŸ”§ Initializing Terraform with GCS backend..."
	@echo "Backend bucket: $(BACKEND_BUCKET)"
	@echo "Backend prefix: $(BACKEND_PREFIX)"
	terraform init \
		-backend-config="bucket=$(BACKEND_BUCKET)" \
		-backend-config="prefix=$(BACKEND_PREFIX)"
	@echo "âœ… Terraform initialized with GCS backend"

plan: check-project ## å®Ÿè¡Œè¨ˆç”»ã‚’è¡¨ç¤º
	terraform plan

apply: check-project ## ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆãƒ»æ›´æ–°
	terraform apply

destroy: check-project ## å…¨ãƒªã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤ï¼ˆæ³¨æ„ï¼ï¼‰
	@echo "âš ï¸  è­¦å‘Š: å…¨ã¦ã®ãƒªã‚½ãƒ¼ã‚¹ãŒå‰Šé™¤ã•ã‚Œã¾ã™ï¼"
	@echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $(PROJECT_ID)"
	@read -p "ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ (yes/no): " confirm && [ "$$confirm" = "yes" ]
	terraform destroy

# æ¤œè¨¼ãƒ»ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
validate: ## è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œè¨¼
	terraform validate

format: ## è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
	terraform fmt -recursive

lint: ## Terraformã‚³ãƒ¼ãƒ‰ã®Lintå®Ÿè¡Œï¼ˆtflintãŒå¿…è¦ï¼‰
	@if command -v tflint >/dev/null 2>&1; then \
		echo "ğŸ” Terraformã‚³ãƒ¼ãƒ‰ã®Lintã‚’å®Ÿè¡Œä¸­..."; \
		tflint --init; \
		tflint; \
		echo "âœ… LintãŒå®Œäº†ã—ã¾ã—ãŸ"; \
	else \
		echo "âŒ tflintãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“"; \
		echo "ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„:"; \
		echo "  brew install tflint"; \
		echo "ã¾ãŸã¯"; \
		echo "  curl -s https://raw.githubusercontent.com/terraform-linters/tflint/master/install_linux.sh | bash"; \
	fi

lint-fix: ## Terraformã‚³ãƒ¼ãƒ‰ã®Lintå®Ÿè¡Œï¼ˆè‡ªå‹•ä¿®æ­£å¯èƒ½ãªå•é¡Œã‚’ä¿®æ­£ï¼‰
	@if command -v tflint >/dev/null 2>&1; then \
		echo "ğŸ”§ Terraformã‚³ãƒ¼ãƒ‰ã®Lintã‚’å®Ÿè¡Œä¸­ï¼ˆè‡ªå‹•ä¿®æ­£ãƒ¢ãƒ¼ãƒ‰ï¼‰..."; \
		tflint --init; \
		tflint --fix; \
		echo "âœ… Lintã¨è‡ªå‹•ä¿®æ­£ãŒå®Œäº†ã—ã¾ã—ãŸ"; \
	else \
		echo "âŒ tflintãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“"; \
		echo "ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„:"; \
		echo "  brew install tflint"; \
		echo "ã¾ãŸã¯"; \
		echo "  curl -s https://raw.githubusercontent.com/terraform-linters/tflint/master/install_linux.sh | bash"; \
	fi


check: validate format lint ## æ¤œè¨¼ã€ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã€Lintã‚’å®Ÿè¡Œ

check-all: validate format lint security-all ## æ¤œè¨¼ã€ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã€Lintã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ã‚’å®Ÿè¡Œ

# æƒ…å ±è¡¨ç¤º
output: ## å‡ºåŠ›å€¤ã‚’è¡¨ç¤º
	terraform output

state: ## ãƒªã‚½ãƒ¼ã‚¹çŠ¶æ…‹ã‚’è¡¨ç¤º
	terraform state list

# ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
clean: ## ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
	rm -rf .terraform/
	rm -f terraform.tfstate.backup
	rm -f .terraform.lock.hcl

# Cloud SQLç®¡ç†
stop-sql: check-project ## Cloud SQLã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’åœæ­¢ï¼ˆã‚³ã‚¹ãƒˆå‰Šæ¸›ï¼‰
	@echo "ğŸ›‘ Cloud SQLã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’åœæ­¢ä¸­..."
	@echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $(PROJECT_ID)"
	@echo "ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹: summeryme-db"
	gcloud sql instances patch summeryme-db --activation-policy=NEVER --quiet
	@echo "âœ… Cloud SQLã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒåœæ­¢ã•ã‚Œã¾ã—ãŸ"
	@echo "ğŸ’° ã“ã‚Œã«ã‚ˆã‚Šã‚³ã‚¹ãƒˆãŒå¤§å¹…ã«å‰Šæ¸›ã•ã‚Œã¾ã™"

start-sql: check-project ## Cloud SQLã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’é–‹å§‹
	@echo "ğŸš€ Cloud SQLã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’é–‹å§‹ä¸­..."
	@echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $(PROJECT_ID)"
	@echo "ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹: summeryme-db"
	gcloud sql instances patch summeryme-db --activation-policy=ALWAYS --quiet
	@echo "âœ… Cloud SQLã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸ"
	@echo "â° èµ·å‹•ã¾ã§æ•°åˆ†ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™"

sql-status: check-project ## Cloud SQLã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®çŠ¶æ…‹ã‚’ç¢ºèª
	@echo "ğŸ“Š Cloud SQLã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®çŠ¶æ…‹:"
	@echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $(PROJECT_ID)"
	gcloud sql instances describe summeryme-db --format="table(name,state,settings.activationPolicy,settings.tier)" 2>/dev/null || echo "âŒ ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"

job-status: check-project ## Cloud Run Jobsã®çŠ¶æ…‹ã‚’ç¢ºèª
	@echo "ğŸ“Š Cloud Run Jobsã®çŠ¶æ…‹:"
	@echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $(PROJECT_ID)"
	@echo ""
	@echo "=== ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¸ãƒ§ãƒ– ==="
	@gcloud run jobs describe migrate-job --region=$(REGION) --format="table(metadata.name,spec.template.spec.template.metadata.labels,status.conditions[0].type,status.conditions[0].status)" 2>/dev/null || echo "âŒ migrate-job ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
	@echo ""
	@echo "=== è¨˜äº‹è¦ç´„ã‚¸ãƒ§ãƒ– ==="
	@gcloud run jobs describe article-summary-job --region=$(REGION) --format="table(metadata.name,spec.template.spec.template.metadata.labels,status.conditions[0].type,status.conditions[0].status)" 2>/dev/null || echo "âŒ article-summary-job ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
	@echo ""
	@echo "=== æ—¥æ¬¡è¦ç´„ã‚¸ãƒ§ãƒ– ==="
	@gcloud run jobs describe daily-summary-job --region=$(REGION) --format="table(metadata.name,spec.template.spec.template.metadata.labels,status.conditions[0].type,status.conditions[0].status)" 2>/dev/null || echo "âŒ daily-summary-job ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"

job-executions: check-project ## Cloud Run Jobsã®å®Ÿè¡Œå±¥æ­´ã‚’ç¢ºèª
	@echo "ğŸ“‹ Cloud Run Jobsã®å®Ÿè¡Œå±¥æ­´:"
	@echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $(PROJECT_ID)"
	@echo ""
	@echo "=== ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¸ãƒ§ãƒ–å®Ÿè¡Œå±¥æ­´ ==="
	@gcloud run jobs executions list --job=migrate-job --region=$(REGION) --limit=5 --format="table(metadata.name,status.completionTime,status.succeededCount,status.failedCount)" 2>/dev/null || echo "âŒ migrate-job ã®å®Ÿè¡Œå±¥æ­´ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
	@echo ""
	@echo "=== è¨˜äº‹è¦ç´„ã‚¸ãƒ§ãƒ–å®Ÿè¡Œå±¥æ­´ ==="
	@gcloud run jobs executions list --job=article-summary-job --region=$(REGION) --limit=5 --format="table(metadata.name,status.completionTime,status.succeededCount,status.failedCount)" 2>/dev/null || echo "âŒ article-summary-job ã®å®Ÿè¡Œå±¥æ­´ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
	@echo ""
	@echo "=== æ—¥æ¬¡è¦ç´„ã‚¸ãƒ§ãƒ–å®Ÿè¡Œå±¥æ­´ ==="
	@gcloud run jobs executions list --job=daily-summary-job --region=$(REGION) --limit=5 --format="table(metadata.name,status.completionTime,status.succeededCount,status.failedCount)" 2>/dev/null || echo "âŒ daily-summary-job ã®å®Ÿè¡Œå±¥æ­´ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"

job-logs: check-project ## Cloud Run Jobsã®ãƒ­ã‚°ã‚’è¡¨ç¤º
	@echo "ğŸ“œ Cloud Run Jobsã®ãƒ­ã‚°:"
	@echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $(PROJECT_ID)"
	@echo ""
	@echo "ã©ã®ã‚¸ãƒ§ãƒ–ã®ãƒ­ã‚°ã‚’è¡¨ç¤ºã—ã¾ã™ã‹ï¼Ÿ"
	@echo "1) migrate-job"
	@echo "2) article-summary-job"
	@echo "3) daily-summary-job"
	@read -p "é¸æŠã—ã¦ãã ã•ã„ (1-3): " choice; \
	case $$choice in \
		1) gcloud logging read "resource.type=cloud_run_job AND resource.labels.job_name=migrate-job" --limit=50 --format="table(timestamp,severity,textPayload)" ;; \
		2) gcloud logging read "resource.type=cloud_run_job AND resource.labels.job_name=article-summary-job" --limit=50 --format="table(timestamp,severity,textPayload)" ;; \
		3) gcloud logging read "resource.type=cloud_run_job AND resource.labels.job_name=daily-summary-job" --limit=50 --format="table(timestamp,severity,textPayload)" ;; \
		*) echo "âŒ ç„¡åŠ¹ãªé¸æŠã§ã™" ;; \
	esac

# ç‰¹å®šãƒªã‚½ãƒ¼ã‚¹æ“ä½œ
plan-cloud-run: check-project ## Cloud Runã‚µãƒ¼ãƒ“ã‚¹ã®ã¿ãƒ—ãƒ©ãƒ³è¡¨ç¤º
	terraform plan -target=google_cloud_run_v2_service.main

apply-cloud-run: check-project ## Cloud Runã‚µãƒ¼ãƒ“ã‚¹ã®ã¿æ›´æ–°
	terraform apply -auto-approve -target=google_cloud_run_v2_service.main

plan-cloud-run-job: check-project ## å…¨Cloud Run Jobã®ãƒ—ãƒ©ãƒ³è¡¨ç¤º
	terraform plan \
		-target=google_cloud_run_v2_job.migrate \
		-target=google_cloud_run_v2_job.article_summary \
		-target=google_cloud_run_v2_job.daily_summary

apply-cloud-run-job: check-project ## å…¨Cloud Run Jobã®æ›´æ–°
	terraform apply -auto-approve \
		-target=google_cloud_run_v2_job.migrate \
		-target=google_cloud_run_v2_job.article_summary \
		-target=google_cloud_run_v2_job.daily_summary

plan-migrate-job: check-project ## ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¸ãƒ§ãƒ–ã®ã¿ãƒ—ãƒ©ãƒ³è¡¨ç¤º
	terraform plan -target=google_cloud_run_v2_job.migrate

apply-migrate-job: check-project ## ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¸ãƒ§ãƒ–ã®ã¿æ›´æ–°
	terraform apply -auto-approve -target=google_cloud_run_v2_job.migrate

plan-article-summary-job: check-project ## è¨˜äº‹è¦ç´„ã‚¸ãƒ§ãƒ–ã®ã¿ãƒ—ãƒ©ãƒ³è¡¨ç¤º
	terraform plan -target=google_cloud_run_v2_job.article_summary

apply-article-summary-job: check-project ## è¨˜äº‹è¦ç´„ã‚¸ãƒ§ãƒ–ã®ã¿æ›´æ–°
	terraform apply -auto-approve -target=google_cloud_run_v2_job.article_summary

plan-daily-summary-job: check-project ## æ—¥æ¬¡è¦ç´„ã‚¸ãƒ§ãƒ–ã®ã¿ãƒ—ãƒ©ãƒ³è¡¨ç¤º
	terraform plan -target=google_cloud_run_v2_job.daily_summary

apply-daily-summary-job: check-project ## æ—¥æ¬¡è¦ç´„ã‚¸ãƒ§ãƒ–ã®ã¿æ›´æ–°
	terraform apply -auto-approve -target=google_cloud_run_v2_job.daily_summary

plan-cloud-sql: check-project ## Cloud SQLã®ã¿ãƒ—ãƒ©ãƒ³è¡¨ç¤º
	terraform plan -target=google_sql_database_instance.main

apply-cloud-sql: check-project ## Cloud SQLã®ã¿æ›´æ–°
	terraform apply -target=google_sql_database_instance.main

plan-vpc: check-project ## VPCãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®ã¿ãƒ—ãƒ©ãƒ³è¡¨ç¤º
	terraform plan -target=google_compute_network.main -target=google_compute_subnetwork.main

apply-vpc: check-project ## VPCãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®ã¿æ›´æ–°
	terraform apply -target=google_compute_network.main -target=google_compute_subnetwork.main

plan-storage: check-project ## GCSã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®ã¿ãƒ—ãƒ©ãƒ³è¡¨ç¤º
	terraform plan -target=google_storage_bucket.audio_files

apply-storage: check-project ## GCSã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®ã¿æ›´æ–°
	terraform apply -target=google_storage_bucket.audio_files

# ã‚¸ãƒ§ãƒ–å®Ÿè¡Œ
migrate: check-project ## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¸ãƒ§ãƒ–ã‚’å®Ÿè¡Œ
	@echo "ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¸ãƒ§ãƒ–ã‚’å®Ÿè¡Œä¸­..."
	@echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $(PROJECT_ID)"
	gcloud run jobs execute migrate-job --region=$(REGION) --wait

run-article-summary: check-project ## è¨˜äº‹è¦ç´„ã‚¸ãƒ§ãƒ–ã‚’å®Ÿè¡Œ
	@echo "è¨˜äº‹è¦ç´„ã‚¸ãƒ§ãƒ–ã‚’å®Ÿè¡Œä¸­..."
	@echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $(PROJECT_ID)"
	gcloud run jobs execute article-summary-job --region=$(REGION) --wait

run-daily-summary: check-project ## æ—¥æ¬¡è¦ç´„ã‚¸ãƒ§ãƒ–ã‚’å®Ÿè¡Œ
	@echo "æ—¥æ¬¡è¦ç´„ã‚¸ãƒ§ãƒ–ã‚’å®Ÿè¡Œä¸­..."
	@echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $(PROJECT_ID)"
	gcloud run jobs execute daily-summary-job --region=$(REGION) --wait

run-all-jobs: check-project ## å…¨ã‚¸ãƒ§ãƒ–ã‚’é †æ¬¡å®Ÿè¡Œ
	@echo "å…¨ã‚¸ãƒ§ãƒ–ã‚’é †æ¬¡å®Ÿè¡Œä¸­..."
	@echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $(PROJECT_ID)"
	@echo "1. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³..."
	gcloud run jobs execute migrate-job --region=$(REGION) --wait
	@echo "2. è¨˜äº‹è¦ç´„..."
	gcloud run jobs execute article-summary-job --region=$(REGION) --wait
	@echo "3. æ—¥æ¬¡è¦ç´„..."
	gcloud run jobs execute daily-summary-job --region=$(REGION) --wait
	@echo "âœ… å…¨ã‚¸ãƒ§ãƒ–ã®å®Ÿè¡ŒãŒå®Œäº†ã—ã¾ã—ãŸ"

# Cloud Scheduleræ“ä½œ
scheduler-list: check-project ## Cloud Schedulerã‚¸ãƒ§ãƒ–ä¸€è¦§ã‚’è¡¨ç¤º
	@echo "ğŸ“‹ Cloud Schedulerã‚¸ãƒ§ãƒ–ä¸€è¦§:"
	@echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $(PROJECT_ID)"
	gcloud scheduler jobs list --location=$(REGION) --format="table(name,schedule,timeZone,state,lastAttemptTime)"

scheduler-status: check-project ## Cloud Schedulerã‚¸ãƒ§ãƒ–ã®è©³ç´°çŠ¶æ…‹ã‚’è¡¨ç¤º
	@echo "ğŸ“Š Cloud Schedulerã‚¸ãƒ§ãƒ–ã®è©³ç´°:"
	@echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $(PROJECT_ID)"
	@echo ""
	@echo "=== è¨˜äº‹è¦ç´„ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ ==="
	@gcloud scheduler jobs describe article-summary-scheduler --location=$(REGION) --format="table(name,schedule,timeZone,state,lastAttemptTime,httpTarget.uri)" 2>/dev/null || echo "âŒ article-summary-scheduler ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
	@echo ""
	@echo "=== æ—¥æ¬¡è¦ç´„ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ ==="
	@gcloud scheduler jobs describe daily-summary-scheduler --location=$(REGION) --format="table(name,schedule,timeZone,state,lastAttemptTime,httpTarget.uri)" 2>/dev/null || echo "âŒ daily-summary-scheduler ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"

scheduler-run-article: check-project ## è¨˜äº‹è¦ç´„ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ã‚’æ‰‹å‹•å®Ÿè¡Œ
	@echo "â–¶ï¸  è¨˜äº‹è¦ç´„ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ã‚’æ‰‹å‹•å®Ÿè¡Œä¸­..."
	@echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $(PROJECT_ID)"
	gcloud scheduler jobs run article-summary-scheduler --location=$(REGION)
	@echo "âœ… æ‰‹å‹•å®Ÿè¡Œã‚’ãƒˆãƒªã‚¬ãƒ¼ã—ã¾ã—ãŸï¼ˆå®Ÿè¡Œå®Œäº†ã¾ã§æ•°åˆ†ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ï¼‰"

scheduler-run-daily: check-project ## æ—¥æ¬¡è¦ç´„ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ã‚’æ‰‹å‹•å®Ÿè¡Œ
	@echo "â–¶ï¸  æ—¥æ¬¡è¦ç´„ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ã‚’æ‰‹å‹•å®Ÿè¡Œä¸­..."
	@echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $(PROJECT_ID)"
	gcloud scheduler jobs run daily-summary-scheduler --location=$(REGION)
	@echo "âœ… æ‰‹å‹•å®Ÿè¡Œã‚’ãƒˆãƒªã‚¬ãƒ¼ã—ã¾ã—ãŸï¼ˆå®Ÿè¡Œå®Œäº†ã¾ã§æ•°åˆ†ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ï¼‰"

scheduler-pause-article: check-project ## è¨˜äº‹è¦ç´„ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ã‚’ä¸€æ™‚åœæ­¢
	@echo "â¸ï¸  è¨˜äº‹è¦ç´„ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ã‚’ä¸€æ™‚åœæ­¢ä¸­..."
	@echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $(PROJECT_ID)"
	gcloud scheduler jobs pause article-summary-scheduler --location=$(REGION)
	@echo "âœ… ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ã‚’ä¸€æ™‚åœæ­¢ã—ã¾ã—ãŸ"

scheduler-pause-daily: check-project ## æ—¥æ¬¡è¦ç´„ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ã‚’ä¸€æ™‚åœæ­¢
	@echo "â¸ï¸  æ—¥æ¬¡è¦ç´„ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ã‚’ä¸€æ™‚åœæ­¢ä¸­..."
	@echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $(PROJECT_ID)"
	gcloud scheduler jobs pause daily-summary-scheduler --location=$(REGION)
	@echo "âœ… ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ã‚’ä¸€æ™‚åœæ­¢ã—ã¾ã—ãŸ"

scheduler-resume-article: check-project ## è¨˜äº‹è¦ç´„ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ã‚’å†é–‹
	@echo "â–¶ï¸  è¨˜äº‹è¦ç´„ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ã‚’å†é–‹ä¸­..."
	@echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $(PROJECT_ID)"
	gcloud scheduler jobs resume article-summary-scheduler --location=$(REGION)
	@echo "âœ… ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ã‚’å†é–‹ã—ã¾ã—ãŸ"

scheduler-resume-daily: check-project ## æ—¥æ¬¡è¦ç´„ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ã‚’å†é–‹
	@echo "â–¶ï¸  æ—¥æ¬¡è¦ç´„ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ã‚’å†é–‹ä¸­..."
	@echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $(PROJECT_ID)"
	gcloud scheduler jobs resume daily-summary-scheduler --location=$(REGION)
	@echo "âœ… ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ã‚’å†é–‹ã—ã¾ã—ãŸ"

scheduler-pause-all: scheduler-pause-article scheduler-pause-daily ## å…¨ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ã‚’ä¸€æ™‚åœæ­¢

scheduler-resume-all: scheduler-resume-article scheduler-resume-daily ## å…¨ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ã‚’å†é–‹

scheduler-logs: check-project ## Cloud Schedulerã®ãƒ­ã‚°ã‚’è¡¨ç¤º
	@echo "ğŸ“œ Cloud Schedulerã®ãƒ­ã‚°:"
	@echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $(PROJECT_ID)"
	@echo ""
	@echo "ã©ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ã®ãƒ­ã‚°ã‚’è¡¨ç¤ºã—ã¾ã™ã‹ï¼Ÿ"
	@echo "1) article-summary-scheduler"
	@echo "2) daily-summary-scheduler"
	@echo "3) å…¨ã¦"
	@read -p "é¸æŠã—ã¦ãã ã•ã„ (1-3): " choice; \
	case $$choice in \
		1) gcloud logging read "resource.type=cloud_scheduler_job AND resource.labels.job_id=article-summary-scheduler" --limit=50 --format="table(timestamp,severity,jsonPayload.message)" ;; \
		2) gcloud logging read "resource.type=cloud_scheduler_job AND resource.labels.job_id=daily-summary-scheduler" --limit=50 --format="table(timestamp,severity,jsonPayload.message)" ;; \
		3) gcloud logging read "resource.type=cloud_scheduler_job" --limit=50 --format="table(timestamp,severity,resource.labels.job_id,jsonPayload.message)" ;; \
		*) echo "âŒ ç„¡åŠ¹ãªé¸æŠã§ã™" ;; \
	esac

plan-scheduler: check-project ## Cloud Schedulerã®ã¿ãƒ—ãƒ©ãƒ³è¡¨ç¤º
	terraform plan \
		-target=google_service_account.cloud_scheduler \
		-target=google_project_iam_member.cloud_scheduler_run_invoker \
		-target=google_cloud_scheduler_job.article_summary \
		-target=google_cloud_scheduler_job.daily_summary

apply-scheduler: check-project ## Cloud Schedulerã®ã¿æ›´æ–°
	terraform apply -auto-approve \
		-target=google_service_account.cloud_scheduler \
		-target=google_project_iam_member.cloud_scheduler_run_invoker \
		-target=google_cloud_scheduler_job.article_summary \
		-target=google_cloud_scheduler_job.daily_summary

import-scheduler: check-project ## æ—¢å­˜ã®Cloud Schedulerã‚¸ãƒ§ãƒ–ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
	@echo "Cloud Schedulerã‚¸ãƒ§ãƒ–ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­..."
	@echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $(PROJECT_ID)"
	@if gcloud scheduler jobs describe article-summary-scheduler --location=$(REGION) >/dev/null 2>&1; then \
		terraform import google_cloud_scheduler_job.article_summary projects/$(PROJECT_ID)/locations/$(REGION)/jobs/article-summary-scheduler; \
		echo "âœ… article-summary-scheduler ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ"; \
	else \
		echo "âŒ article-summary-scheduler ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"; \
	fi
	@if gcloud scheduler jobs describe daily-summary-scheduler --location=$(REGION) >/dev/null 2>&1; then \
		terraform import google_cloud_scheduler_job.daily_summary projects/$(PROJECT_ID)/locations/$(REGION)/jobs/daily-summary-scheduler; \
		echo "âœ… daily-summary-scheduler ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ"; \
	else \
		echo "âŒ daily-summary-scheduler ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"; \
	fi

# ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ“ä½œ
import-cloud-run: check-project ## æ—¢å­˜ã®Cloud Runã‚µãƒ¼ãƒ“ã‚¹ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
	@echo "Cloud Runã‚µãƒ¼ãƒ“ã‚¹ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­..."
	@echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $(PROJECT_ID)"
	terraform import google_cloud_run_v2_service.main projects/$(PROJECT_ID)/locations/$(REGION)/services/backend-api

import-cloud-run-job: check-project ## æ—¢å­˜ã®Cloud Run Jobã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
	@echo "Cloud Run Jobã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­..."
	@echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $(PROJECT_ID)"
	@if gcloud run jobs describe migrate-job --region=$(REGION) >/dev/null 2>&1; then \
		terraform import google_cloud_run_v2_job.migrate projects/$(PROJECT_ID)/locations/$(REGION)/jobs/migrate-job; \
		echo "âœ… migrate-job ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ"; \
	else \
		echo "âŒ migrate-job ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"; \
	fi
	@if gcloud run jobs describe article-summary-job --region=$(REGION) >/dev/null 2>&1; then \
		terraform import google_cloud_run_v2_job.article_summary projects/$(PROJECT_ID)/locations/$(REGION)/jobs/article-summary-job; \
		echo "âœ… article-summary-job ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ"; \
	else \
		echo "âŒ article-summary-job ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"; \
	fi
	@if gcloud run jobs describe daily-summary-job --region=$(REGION) >/dev/null 2>&1; then \
		terraform import google_cloud_run_v2_job.daily_summary projects/$(PROJECT_ID)/locations/$(REGION)/jobs/daily-summary-job; \
		echo "âœ… daily-summary-job ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ"; \
	else \
		echo "âŒ daily-summary-job ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"; \
	fi

import-migrate-job: check-project ## ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¸ãƒ§ãƒ–ã®ã¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
	@echo "ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¸ãƒ§ãƒ–ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­..."
	@echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $(PROJECT_ID)"
	terraform import google_cloud_run_v2_job.migrate projects/$(PROJECT_ID)/locations/$(REGION)/jobs/migrate-job

import-article-summary-job: check-project ## è¨˜äº‹è¦ç´„ã‚¸ãƒ§ãƒ–ã®ã¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
	@echo "è¨˜äº‹è¦ç´„ã‚¸ãƒ§ãƒ–ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­..."
	@echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $(PROJECT_ID)"
	terraform import google_cloud_run_v2_job.article_summary projects/$(PROJECT_ID)/locations/$(REGION)/jobs/article-summary-job

import-daily-summary-job: check-project ## æ—¥æ¬¡è¦ç´„ã‚¸ãƒ§ãƒ–ã®ã¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
	@echo "æ—¥æ¬¡è¦ç´„ã‚¸ãƒ§ãƒ–ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­..."
	@echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $(PROJECT_ID)"
	terraform import google_cloud_run_v2_job.daily_summary projects/$(PROJECT_ID)/locations/$(REGION)/jobs/daily-summary-job

import-cloud-sql: check-project ## æ—¢å­˜ã®Cloud SQLã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
	@echo "Cloud SQLã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­..."
	@echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $(PROJECT_ID)"
	terraform import google_sql_database_instance.main summeryme-db

import-cloud-sql-database: check-project ## æ—¢å­˜ã®Cloud SQLãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
	@echo "Cloud SQLãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­..."
	@echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $(PROJECT_ID)"
	terraform import google_sql_database.main $(PROJECT_ID)/summeryme-db/summeryme_production

import-cloud-sql-user: check-project ## æ—¢å­˜ã®Cloud SQLãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
	@echo "Cloud SQLãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­..."
	@echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $(PROJECT_ID)"
	terraform import google_sql_user.main $(PROJECT_ID)/summeryme-db/summeryme_user

import-secret: check-project ## æ—¢å­˜ã®Secret Managerã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
	@echo "Secret Managerã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­..."
	@echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $(PROJECT_ID)"
	terraform import google_secret_manager_secret.db_password projects/$(PROJECT_ID)/secrets/db-password

import-secret-version: check-project ## æ—¢å­˜ã®Secret Managerã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
	@echo "Secret Managerã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­..."
	@echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $(PROJECT_ID)"
	@SECRET_VERSION=$$(gcloud secrets versions list db-password --limit=1 --format="value(name)") && \
	terraform import google_secret_manager_secret_version.db_password projects/$(PROJECT_ID)/secrets/db-password/versions/$$SECRET_VERSION

import-service-accounts: check-project ## æ—¢å­˜ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
	@echo "ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­..."
	@echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $(PROJECT_ID)"
	@if gcloud iam service-accounts describe backend-api-sa@$(PROJECT_ID).iam.gserviceaccount.com >/dev/null 2>&1; then \
		terraform import google_service_account.cloud_run projects/$(PROJECT_ID)/serviceAccounts/backend-api-sa@$(PROJECT_ID).iam.gserviceaccount.com; \
	else \
		echo "backend-api-sa ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆæ–°è¦ä½œæˆã•ã‚Œã¾ã™ï¼‰"; \
	fi
	@if gcloud iam service-accounts describe github-actions@$(PROJECT_ID).iam.gserviceaccount.com >/dev/null 2>&1; then \
		terraform import google_service_account.github_actions projects/$(PROJECT_ID)/serviceAccounts/github-actions@$(PROJECT_ID).iam.gserviceaccount.com; \
	else \
		echo "github-actions ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆæ–°è¦ä½œæˆã•ã‚Œã¾ã™ï¼‰"; \
	fi

import-apis: check-project ## æ—¢å­˜ã®APIã‚µãƒ¼ãƒ“ã‚¹ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
	@echo "APIã‚µãƒ¼ãƒ“ã‚¹ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­..."
	@echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $(PROJECT_ID)"
	@for api in run.googleapis.com sqladmin.googleapis.com secretmanager.googleapis.com cloudbuild.googleapis.com containerregistry.googleapis.com artifactregistry.googleapis.com logging.googleapis.com monitoring.googleapis.com compute.googleapis.com servicenetworking.googleapis.com vpcaccess.googleapis.com storage.googleapis.com cloudscheduler.googleapis.com; do \
		echo "ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­: $$api"; \
		terraform import "google_project_service.required_apis[\"$$api\"]" $(PROJECT_ID)/$$api || echo "$$api ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ï¼ˆæ—¢ã«æœ‰åŠ¹åŒ–æ¸ˆã¿ã®å¯èƒ½æ€§ï¼‰"; \
	done

import-artifact-registry: check-project ## æ—¢å­˜ã®Artifact Registryãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
	@echo "Artifact Registryãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­..."
	@echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $(PROJECT_ID)"
	@if gcloud artifacts repositories describe backend --location=$(REGION) >/dev/null 2>&1; then \
		terraform import google_artifact_registry_repository.backend projects/$(PROJECT_ID)/locations/$(REGION)/repositories/backend; \
	else \
		echo "backend ãƒªãƒã‚¸ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆæ–°è¦ä½œæˆã•ã‚Œã¾ã™ï¼‰"; \
	fi

import-cloud-run-iam: check-project ## æ—¢å­˜ã®Cloud Run IAMè¨­å®šã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
	@echo "Cloud Run IAMè¨­å®šã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­..."
	@echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $(PROJECT_ID)"
	@if gcloud run services get-iam-policy backend-api --region=$(REGION) --format="value(bindings.members)" | grep -q "allUsers"; then \
		terraform import "google_cloud_run_service_iam_member.public_access[0]" "projects/$(PROJECT_ID)/locations/$(REGION)/services/backend-api roles/run.invoker allUsers"; \
	else \
		echo "ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹è¨­å®šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆæ–°è¦ä½œæˆã•ã‚Œã¾ã™ï¼‰"; \
	fi

import-storage: check-project ## æ—¢å­˜ã®GCSãƒã‚±ãƒƒãƒˆã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
	@echo "GCSãƒã‚±ãƒƒãƒˆã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­..."
	@echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $(PROJECT_ID)"
	@BUCKET_NAME="$(PROJECT_ID)-summeryme-audio"; \
	if gsutil ls -b gs://$$BUCKET_NAME >/dev/null 2>&1; then \
		terraform import google_storage_bucket.audio_files $$BUCKET_NAME; \
		echo "âœ… ãƒã‚±ãƒƒãƒˆ $$BUCKET_NAME ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ"; \
	else \
		echo "âŒ ãƒã‚±ãƒƒãƒˆ $$BUCKET_NAME ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆæ–°è¦ä½œæˆã•ã‚Œã¾ã™ï¼‰"; \
	fi

import-storage-iam: check-project ## æ—¢å­˜ã®GCSãƒã‚±ãƒƒãƒˆIAMè¨­å®šã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
	@echo "GCSãƒã‚±ãƒƒãƒˆIAMè¨­å®šã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­..."
	@echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $(PROJECT_ID)"
	@BUCKET_NAME="$(PROJECT_ID)-summeryme-audio"; \
	SERVICE_ACCOUNT="backend-api-sa@$(PROJECT_ID).iam.gserviceaccount.com"; \
	if gsutil iam get gs://$$BUCKET_NAME | grep -q "$$SERVICE_ACCOUNT"; then \
		terraform import google_storage_bucket_iam_member.audio_bucket_admin "b/$$BUCKET_NAME roles/storage.objectAdmin serviceAccount:$$SERVICE_ACCOUNT"; \
		echo "âœ… Cloud Runã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®IAMè¨­å®šã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ"; \
	else \
		echo "âŒ Cloud Runã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®IAMè¨­å®šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆæ–°è¦ä½œæˆã•ã‚Œã¾ã™ï¼‰"; \
	fi
	@GITHUB_SA="github-actions@$(PROJECT_ID).iam.gserviceaccount.com"; \
	if gsutil iam get gs://$$BUCKET_NAME | grep -q "$$GITHUB_SA"; then \
		terraform import google_storage_bucket_iam_member.audio_bucket_github_admin "b/$$BUCKET_NAME roles/storage.objectAdmin serviceAccount:$$GITHUB_SA"; \
		echo "âœ… GitHub Actionsã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®IAMè¨­å®šã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ"; \
	else \
		echo "âŒ GitHub Actionsã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®IAMè¨­å®šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆæ–°è¦ä½œæˆã•ã‚Œã¾ã™ï¼‰"; \
	fi

# ç’°å¢ƒåˆ¥æ“ä½œ
setup-dev: check-project ## é–‹ç™ºç’°å¢ƒç”¨ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
	@if [ ! -f terraform.tfvars ]; then \
		cp terraform.tfvars.example terraform.tfvars; \
		sed -i '' 's/your-gcp-project-id/$(PROJECT_ID)/g' terraform.tfvars; \
		sed -i '' 's/your-project/$(PROJECT_ID)/g' terraform.tfvars; \
		sed -i '' 's/environment = "production"/environment = "development"/' terraform.tfvars; \
		echo "é–‹ç™ºç’°å¢ƒç”¨ã®terraform.tfvarsã‚’ä½œæˆã—ã¾ã—ãŸ (ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $(PROJECT_ID))"; \
	else \
		echo "terraform.tfvarsã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™"; \
	fi

setup-prod: check-project ## æœ¬ç•ªç’°å¢ƒç”¨ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
	@if [ ! -f terraform.tfvars ]; then \
		cp terraform.tfvars.example terraform.tfvars; \
		sed -i '' 's/your-gcp-project-id/$(PROJECT_ID)/g' terraform.tfvars; \
		sed -i '' 's/your-project/$(PROJECT_ID)/g' terraform.tfvars; \
		echo "æœ¬ç•ªç’°å¢ƒç”¨ã®terraform.tfvarsã‚’ä½œæˆã—ã¾ã—ãŸ (ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $(PROJECT_ID))"; \
	else \
		echo "terraform.tfvarsã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™"; \
	fi

# ãƒ‡ãƒãƒƒã‚°
debug: check-project ## ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã§ãƒ—ãƒ©ãƒ³ã‚’å®Ÿè¡Œ
	TF_LOG=DEBUG terraform plan

# çŠ¶æ…‹ç®¡ç†
backup-state: ## stateãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆ
	@if [ -f terraform.tfstate ]; then \
		cp terraform.tfstate terraform.tfstate.backup.$(shell date +%Y%m%d_%H%M%S); \
		echo "stateãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¾ã—ãŸ"; \
	else \
		echo "terraform.tfstateãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"; \
	fi

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
security-scan: ## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ã‚’å®Ÿè¡Œï¼ˆtfsecãŒå¿…è¦ï¼‰
	@if command -v tfsec >/dev/null 2>&1; then \
		echo "ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ã‚’å®Ÿè¡Œä¸­..."; \
		if [ -f terraform.tfvars ]; then \
			tfsec . --tfvars-file terraform.tfvars --format lovely; \
		else \
			tfsec . --format lovely; \
		fi; \
		echo ""; \
		echo "ğŸ’¡ è©³ç´°æƒ…å ±: https://aquasecurity.github.io/tfsec/"; \
	else \
		echo "âŒ tfsecãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“"; \
		echo "ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„:"; \
		echo "  brew install tfsec"; \
		echo "ã¾ãŸã¯"; \
		echo "  curl -s https://raw.githubusercontent.com/aquasecurity/tfsec/master/scripts/install_linux.sh | bash"; \
	fi

checkov: ## Checkovã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹ã‚¹ã‚­ãƒ£ãƒ³ã‚’å®Ÿè¡Œ
	@if python3 -c "import checkov" 2>/dev/null; then \
		echo "ğŸ“‹ Checkovã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹ã‚¹ã‚­ãƒ£ãƒ³ã‚’å®Ÿè¡Œä¸­..."; \
		python3 -m checkov.main -d . --framework terraform --compact; \
		echo "âœ… Checkovã‚¹ã‚­ãƒ£ãƒ³ãŒå®Œäº†ã—ã¾ã—ãŸ"; \
	else \
		echo "âŒ checkovãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“"; \
		echo "ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„:"; \
		echo "  pip install checkov"; \
		echo "ã¾ãŸã¯"; \
		echo "  brew install checkov"; \
	fi

checkov-json: ## Checkovã‚¹ã‚­ãƒ£ãƒ³ã‚’å®Ÿè¡Œã—ã¦JSONå½¢å¼ã§å‡ºåŠ›
	@if python3 -c "import checkov" 2>/dev/null; then \
		echo "ğŸ“‹ Checkovã‚¹ã‚­ãƒ£ãƒ³ã‚’å®Ÿè¡Œä¸­ï¼ˆJSONå‡ºåŠ›ï¼‰..."; \
		python3 -m checkov.main -d . --framework terraform --output json --output-file checkov-results.json; \
		echo "âœ… çµæœã‚’checkov-results.jsonã«ä¿å­˜ã—ã¾ã—ãŸ"; \
	else \
		echo "âŒ checkovãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“"; \
	fi

checkov-quiet: ## Checkovã‚¹ã‚­ãƒ£ãƒ³ã‚’å®Ÿè¡Œï¼ˆç°¡æ½”å‡ºåŠ›ï¼‰
	@if python3 -c "import checkov" 2>/dev/null; then \
		echo "ğŸ“‹ Checkovã‚¹ã‚­ãƒ£ãƒ³ã‚’å®Ÿè¡Œä¸­ï¼ˆç°¡æ½”ãƒ¢ãƒ¼ãƒ‰ï¼‰..."; \
		python3 -m checkov.main -d . --framework terraform --quiet; \
		echo "âœ… Checkovã‚¹ã‚­ãƒ£ãƒ³ãŒå®Œäº†ã—ã¾ã—ãŸ"; \
	else \
		echo "âŒ checkovãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“"; \
	fi

security-all: security-scan checkov ## å…¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ã‚’å®Ÿè¡Œï¼ˆtfsec + checkovï¼‰

# ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç”Ÿæˆ
docs: ## Terraformãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆï¼ˆterraform-docsãŒå¿…è¦ï¼‰
	@if command -v terraform-docs >/dev/null 2>&1; then \
		terraform-docs markdown table . > TERRAFORM_DOCS.md; \
		echo "ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’TERRAFORM_DOCS.mdã«ç”Ÿæˆã—ã¾ã—ãŸ"; \
	else \
		echo "terraform-docsãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚brew install terraform-docs ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„"; \
	fi

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±è¡¨ç¤º
project-info: check-project ## ç¾åœ¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã‚’è¡¨ç¤º
	@echo "=== ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ± ==="
	@echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID: $(PROJECT_ID)"
	@echo "ãƒªãƒ¼ã‚¸ãƒ§ãƒ³: $(REGION)"
	@echo ""
	@echo "=== æ—¢å­˜ãƒªã‚½ãƒ¼ã‚¹ç¢ºèª ==="
	@echo "Cloud Runã‚µãƒ¼ãƒ“ã‚¹:"
	@gcloud run services list --region=$(REGION) --format="table(metadata.name,status.url)" 2>/dev/null || echo "  ãªã—"
	@echo ""
	@echo "Cloud SQLã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹:"
	@gcloud sql instances list --format="table(name,databaseVersion,region,settings.tier)" 2>/dev/null || echo "  ãªã—"
	@echo ""
	@echo "Secret Manager:"
	@gcloud secrets list --format="table(name)" 2>/dev/null || echo "  ãªã—"

# å®Œå…¨ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
setup: init setup-prod validate ## åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’å®Ÿè¡Œ
	@echo "âœ… Terraformã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸ"
	@echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $(PROJECT_ID)"
	@echo ""
	@echo "æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:"
	@echo "1. terraform.tfvarsãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªãƒ»ç·¨é›†"
	@echo "2. make plan ã§ãƒ—ãƒ©ãƒ³ã‚’ç¢ºèª"
	@echo "3. make apply ã§ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆ"

# å…¨ä½“ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
import-all: import-apis import-service-accounts import-cloud-sql import-cloud-sql-database import-cloud-run import-cloud-run-job import-scheduler import-secret import-artifact-registry import-storage import-storage-iam ## å…¨ã¦ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ

# çŠ¶æ…‹ç®¡ç†
init-local: check-project ## ãƒ­ãƒ¼ã‚«ãƒ«çŠ¶æ…‹ã§Terraformã‚’åˆæœŸåŒ–
	terraform init

init-gcs: check-project ## GCSçŠ¶æ…‹ã§Terraformã‚’åˆæœŸåŒ–
	@echo "ğŸ”§ Initializing Terraform with GCS backend..."
	@echo "Backend bucket: $(BACKEND_BUCKET)"
	@echo "Backend prefix: $(BACKEND_PREFIX)"
	terraform init \
		-backend-config="bucket=$(BACKEND_BUCKET)" \
		-backend-config="prefix=$(BACKEND_PREFIX)"
	@echo "âœ… Terraform initialized with GCS backend"

migrate-to-gcs: check-project ## ãƒ­ãƒ¼ã‚«ãƒ«çŠ¶æ…‹ã‚’GCSã«ç§»è¡Œ
	@echo "ğŸ”„ Migrating local state to GCS backend..."
	@echo "Backend bucket: $(BACKEND_BUCKET)"
	@echo "Backend prefix: $(BACKEND_PREFIX)"
	@echo ""
	@echo "âš ï¸  æ³¨æ„: ã“ã®æ“ä½œã«ã‚ˆã‚Šã€ãƒ­ãƒ¼ã‚«ãƒ«ã® terraform.tfstate ãŒGCSã«ç§»è¡Œã•ã‚Œã¾ã™"
	@read -p "ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ (yes/no): " confirm && [ "$$confirm" = "yes" ]
	terraform init -migrate-state \
		-backend-config="bucket=$(BACKEND_BUCKET)" \
		-backend-config="prefix=$(BACKEND_PREFIX)"
	@echo "âœ… State migration completed"

backup-local-state: ## ãƒ­ãƒ¼ã‚«ãƒ«çŠ¶æ…‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
	@if [ -f terraform.tfstate ]; then \
		cp terraform.tfstate terraform.tfstate.backup-$(shell date +%Y%m%d-%H%M%S); \
		echo "âœ… Local state backed up"; \
	else \
		echo "âŒ No local state file found"; \
	fi