# Makefile for Terraform Operations
# Summeryme AI Backend Infrastructure

.PHONY: help init plan apply destroy validate format check clean import output state

# å‹•çš„ã«GCPãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDã‚’å–å¾—
PROJECT_ID := $(shell gcloud config get-value project 2>/dev/null)
REGION := asia-northeast1

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
check-project:
	@if [ -z "$(PROJECT_ID)" ]; then \
		echo "âŒ ã‚¨ãƒ©ãƒ¼: GCPãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"; \
		echo "ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’è¨­å®šã—ã¦ãã ã•ã„:"; \
		echo "  gcloud config set project YOUR_PROJECT_ID"; \
		exit 1; \
	else \
		echo "âœ… ä½¿ç”¨ä¸­ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $(PROJECT_ID)"; \
	fi

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
help: ## ã“ã®ãƒ˜ãƒ«ãƒ—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
	@echo "Summeryme AI Backend - Terraform Operations"
	@echo ""
	@echo "ç¾åœ¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $(PROJECT_ID)"
	@echo ""
	@echo "åˆ©ç”¨å¯èƒ½ãªã‚³ãƒãƒ³ãƒ‰:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-15s\033[0m %s\n", $$1, $$2}'

# åŸºæœ¬æ“ä½œ
init: check-project ## Terraformã‚’åˆæœŸåŒ–
	terraform init

plan: check-project ## å®Ÿè¡Œè¨ˆç”»ã‚’è¡¨ç¤º
	terraform plan

apply: check-project ## ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆãƒ»æ›´æ–°
	terraform apply

destroy: check-project ## å…¨ãƒªã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤ï¼ˆæ³¨æ„ï¼ï¼‰
	@echo "âš ï¸  è­¦å‘Š: å…¨ã¦ã®ãƒªã‚½ãƒ¼ã‚¹ãŒå‰Šé™¤ã•ã‚Œã¾ã™ï¼"
	@echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $(PROJECT_ID)"
	@read -p "ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ (yes/no): " confirm && [ "$$confirm" = "yes" ]
	terraform destroy

# æ¤œè¨¼ãƒ»ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
validate: ## è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œè¨¼
	terraform validate

format: ## è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
	terraform fmt -recursive

check: validate format ## æ¤œè¨¼ã¨ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’å®Ÿè¡Œ

# æƒ…å ±è¡¨ç¤º
output: ## å‡ºåŠ›å€¤ã‚’è¡¨ç¤º
	terraform output

state: ## ãƒªã‚½ãƒ¼ã‚¹çŠ¶æ…‹ã‚’è¡¨ç¤º
	terraform state list

# ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
clean: ## ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
	rm -rf .terraform/
	rm -f terraform.tfstate.backup
	rm -f .terraform.lock.hcl

# Cloud SQLç®¡ç†
stop-sql: check-project ## Cloud SQLã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’åœæ­¢ï¼ˆã‚³ã‚¹ãƒˆå‰Šæ¸›ï¼‰
	@echo "ğŸ›‘ Cloud SQLã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’åœæ­¢ä¸­..."
	@echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $(PROJECT_ID)"
	@echo "ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹: summeryme-db"
	gcloud sql instances patch summeryme-db --activation-policy=NEVER --quiet
	@echo "âœ… Cloud SQLã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒåœæ­¢ã•ã‚Œã¾ã—ãŸ"
	@echo "ğŸ’° ã“ã‚Œã«ã‚ˆã‚Šã‚³ã‚¹ãƒˆãŒå¤§å¹…ã«å‰Šæ¸›ã•ã‚Œã¾ã™"

start-sql: check-project ## Cloud SQLã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’é–‹å§‹
	@echo "ğŸš€ Cloud SQLã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’é–‹å§‹ä¸­..."
	@echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $(PROJECT_ID)"
	@echo "ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹: summeryme-db"
	gcloud sql instances patch summeryme-db --activation-policy=ALWAYS --quiet
	@echo "âœ… Cloud SQLã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸ"
	@echo "â° èµ·å‹•ã¾ã§æ•°åˆ†ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™"

sql-status: check-project ## Cloud SQLã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®çŠ¶æ…‹ã‚’ç¢ºèª
	@echo "ğŸ“Š Cloud SQLã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®çŠ¶æ…‹:"
	@echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $(PROJECT_ID)"
	gcloud sql instances describe summeryme-db --format="table(name,state,settings.activationPolicy,settings.tier)" 2>/dev/null || echo "âŒ ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"

# ç‰¹å®šãƒªã‚½ãƒ¼ã‚¹æ“ä½œ
plan-cloud-run: check-project ## Cloud Runã‚µãƒ¼ãƒ“ã‚¹ã®ã¿ãƒ—ãƒ©ãƒ³è¡¨ç¤º
	terraform plan -target=google_cloud_run_v2_service.main

apply-cloud-run: check-project ## Cloud Runã‚µãƒ¼ãƒ“ã‚¹ã®ã¿æ›´æ–°
	terraform apply -target=google_cloud_run_v2_service.main

plan-cloud-sql: check-project ## Cloud SQLã®ã¿ãƒ—ãƒ©ãƒ³è¡¨ç¤º
	terraform plan -target=google_sql_database_instance.main

apply-cloud-sql: check-project ## Cloud SQLã®ã¿æ›´æ–°
	terraform apply -target=google_sql_database_instance.main

plan-vpc: check-project ## VPCãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®ã¿ãƒ—ãƒ©ãƒ³è¡¨ç¤º
	terraform plan -target=google_compute_network.main -target=google_compute_subnetwork.main

apply-vpc: check-project ## VPCãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®ã¿æ›´æ–°
	terraform apply -target=google_compute_network.main -target=google_compute_subnetwork.main

# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
migrate: check-project ## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¸ãƒ§ãƒ–ã‚’å®Ÿè¡Œ
	@echo "ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¸ãƒ§ãƒ–ã‚’å®Ÿè¡Œä¸­..."
	@echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $(PROJECT_ID)"
	gcloud run jobs execute migrate-job --region=$(REGION) --wait

# ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ“ä½œ
import-cloud-run: check-project ## æ—¢å­˜ã®Cloud Runã‚µãƒ¼ãƒ“ã‚¹ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
	@echo "Cloud Runã‚µãƒ¼ãƒ“ã‚¹ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­..."
	@echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $(PROJECT_ID)"
	terraform import google_cloud_run_v2_service.main projects/$(PROJECT_ID)/locations/$(REGION)/services/backend-api

import-cloud-run-job: check-project ## æ—¢å­˜ã®Cloud Run Jobã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
	@echo "Cloud Run Jobã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­..."
	@echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $(PROJECT_ID)"
	terraform import google_cloud_run_v2_job.migrate projects/$(PROJECT_ID)/locations/$(REGION)/jobs/migrate-job

import-cloud-sql: check-project ## æ—¢å­˜ã®Cloud SQLã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
	@echo "Cloud SQLã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­..."
	@echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $(PROJECT_ID)"
	terraform import google_sql_database_instance.main summeryme-db

import-cloud-sql-database: check-project ## æ—¢å­˜ã®Cloud SQLãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
	@echo "Cloud SQLãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­..."
	@echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $(PROJECT_ID)"
	terraform import google_sql_database.main $(PROJECT_ID)/summeryme-db/summeryme_production

import-cloud-sql-user: check-project ## æ—¢å­˜ã®Cloud SQLãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
	@echo "Cloud SQLãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­..."
	@echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $(PROJECT_ID)"
	terraform import google_sql_user.main $(PROJECT_ID)/summeryme-db/summeryme_user

import-secret: check-project ## æ—¢å­˜ã®Secret Managerã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
	@echo "Secret Managerã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­..."
	@echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $(PROJECT_ID)"
	terraform import google_secret_manager_secret.db_password projects/$(PROJECT_ID)/secrets/db-password

import-secret-version: check-project ## æ—¢å­˜ã®Secret Managerã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
	@echo "Secret Managerã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­..."
	@echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $(PROJECT_ID)"
	@SECRET_VERSION=$$(gcloud secrets versions list db-password --limit=1 --format="value(name)") && \
	terraform import google_secret_manager_secret_version.db_password projects/$(PROJECT_ID)/secrets/db-password/versions/$$SECRET_VERSION

import-service-accounts: check-project ## æ—¢å­˜ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
	@echo "ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­..."
	@echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $(PROJECT_ID)"
	@if gcloud iam service-accounts describe backend-api-sa@$(PROJECT_ID).iam.gserviceaccount.com >/dev/null 2>&1; then \
		terraform import google_service_account.cloud_run projects/$(PROJECT_ID)/serviceAccounts/backend-api-sa@$(PROJECT_ID).iam.gserviceaccount.com; \
	else \
		echo "backend-api-sa ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆæ–°è¦ä½œæˆã•ã‚Œã¾ã™ï¼‰"; \
	fi
	@if gcloud iam service-accounts describe github-actions@$(PROJECT_ID).iam.gserviceaccount.com >/dev/null 2>&1; then \
		terraform import google_service_account.github_actions projects/$(PROJECT_ID)/serviceAccounts/github-actions@$(PROJECT_ID).iam.gserviceaccount.com; \
	else \
		echo "github-actions ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆæ–°è¦ä½œæˆã•ã‚Œã¾ã™ï¼‰"; \
	fi

import-apis: check-project ## æ—¢å­˜ã®APIã‚µãƒ¼ãƒ“ã‚¹ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
	@echo "APIã‚µãƒ¼ãƒ“ã‚¹ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­..."
	@echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $(PROJECT_ID)"
	@for api in run.googleapis.com sqladmin.googleapis.com secretmanager.googleapis.com cloudbuild.googleapis.com containerregistry.googleapis.com artifactregistry.googleapis.com logging.googleapis.com monitoring.googleapis.com compute.googleapis.com servicenetworking.googleapis.com vpcaccess.googleapis.com; do \
		echo "ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­: $$api"; \
		terraform import "google_project_service.required_apis[\"$$api\"]" $(PROJECT_ID)/$$api || echo "$$api ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ï¼ˆæ—¢ã«æœ‰åŠ¹åŒ–æ¸ˆã¿ã®å¯èƒ½æ€§ï¼‰"; \
	done

import-artifact-registry: check-project ## æ—¢å­˜ã®Artifact Registryãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
	@echo "Artifact Registryãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­..."
	@echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $(PROJECT_ID)"
	@if gcloud artifacts repositories describe backend --location=$(REGION) >/dev/null 2>&1; then \
		terraform import google_artifact_registry_repository.backend projects/$(PROJECT_ID)/locations/$(REGION)/repositories/backend; \
	else \
		echo "backend ãƒªãƒã‚¸ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆæ–°è¦ä½œæˆã•ã‚Œã¾ã™ï¼‰"; \
	fi

import-cloud-run-iam: check-project ## æ—¢å­˜ã®Cloud Run IAMè¨­å®šã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
	@echo "Cloud Run IAMè¨­å®šã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­..."
	@echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $(PROJECT_ID)"
	@if gcloud run services get-iam-policy backend-api --region=$(REGION) --format="value(bindings.members)" | grep -q "allUsers"; then \
		terraform import "google_cloud_run_service_iam_member.public_access[0]" "projects/$(PROJECT_ID)/locations/$(REGION)/services/backend-api roles/run.invoker allUsers"; \
	else \
		echo "ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹è¨­å®šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆæ–°è¦ä½œæˆã•ã‚Œã¾ã™ï¼‰"; \
	fi

# ç’°å¢ƒåˆ¥æ“ä½œ
setup-dev: check-project ## é–‹ç™ºç’°å¢ƒç”¨ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
	@if [ ! -f terraform.tfvars ]; then \
		cp terraform.tfvars.example terraform.tfvars; \
		sed -i '' 's/project_id = "your-gcp-project-id"/project_id = "$(PROJECT_ID)"/' terraform.tfvars; \
		sed -i '' 's/environment = "production"/environment = "development"/' terraform.tfvars; \
		sed -i '' 's/db_tier = "db-f1-micro"/db_tier = "db-f1-micro"/' terraform.tfvars; \
		echo "é–‹ç™ºç’°å¢ƒç”¨ã®terraform.tfvarsã‚’ä½œæˆã—ã¾ã—ãŸ (ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $(PROJECT_ID))"; \
	else \
		echo "terraform.tfvarsã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™"; \
	fi

setup-prod: check-project ## æœ¬ç•ªç’°å¢ƒç”¨ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
	@if [ ! -f terraform.tfvars ]; then \
		cp terraform.tfvars.example terraform.tfvars; \
		sed -i '' 's/project_id = "your-gcp-project-id"/project_id = "$(PROJECT_ID)"/' terraform.tfvars; \
		echo "æœ¬ç•ªç’°å¢ƒç”¨ã®terraform.tfvarsã‚’ä½œæˆã—ã¾ã—ãŸ (ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $(PROJECT_ID))"; \
	else \
		echo "terraform.tfvarsã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™"; \
	fi

# ãƒ‡ãƒãƒƒã‚°
debug: check-project ## ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã§ãƒ—ãƒ©ãƒ³ã‚’å®Ÿè¡Œ
	TF_LOG=DEBUG terraform plan

# çŠ¶æ…‹ç®¡ç†
backup-state: ## stateãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆ
	@if [ -f terraform.tfstate ]; then \
		cp terraform.tfstate terraform.tfstate.backup.$(shell date +%Y%m%d_%H%M%S); \
		echo "stateãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¾ã—ãŸ"; \
	else \
		echo "terraform.tfstateãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"; \
	fi

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
security-scan: ## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ã‚’å®Ÿè¡Œï¼ˆtfsecãŒå¿…è¦ï¼‰
	@if command -v tfsec >/dev/null 2>&1; then \
		tfsec .; \
	else \
		echo "tfsecãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚brew install tfsec ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„"; \
	fi

# ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç”Ÿæˆ
docs: ## Terraformãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆï¼ˆterraform-docsãŒå¿…è¦ï¼‰
	@if command -v terraform-docs >/dev/null 2>&1; then \
		terraform-docs markdown table . > TERRAFORM_DOCS.md; \
		echo "ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’TERRAFORM_DOCS.mdã«ç”Ÿæˆã—ã¾ã—ãŸ"; \
	else \
		echo "terraform-docsãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚brew install terraform-docs ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„"; \
	fi

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±è¡¨ç¤º
project-info: check-project ## ç¾åœ¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã‚’è¡¨ç¤º
	@echo "=== ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ± ==="
	@echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID: $(PROJECT_ID)"
	@echo "ãƒªãƒ¼ã‚¸ãƒ§ãƒ³: $(REGION)"
	@echo ""
	@echo "=== æ—¢å­˜ãƒªã‚½ãƒ¼ã‚¹ç¢ºèª ==="
	@echo "Cloud Runã‚µãƒ¼ãƒ“ã‚¹:"
	@gcloud run services list --region=$(REGION) --format="table(metadata.name,status.url)" 2>/dev/null || echo "  ãªã—"
	@echo ""
	@echo "Cloud SQLã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹:"
	@gcloud sql instances list --format="table(name,databaseVersion,region,settings.tier)" 2>/dev/null || echo "  ãªã—"
	@echo ""
	@echo "Secret Manager:"
	@gcloud secrets list --format="table(name)" 2>/dev/null || echo "  ãªã—"

# å®Œå…¨ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
setup: init setup-prod validate ## åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’å®Ÿè¡Œ
	@echo "âœ… Terraformã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸ"
	@echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $(PROJECT_ID)"
	@echo ""
	@echo "æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:"
	@echo "1. terraform.tfvarsãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªãƒ»ç·¨é›†"
	@echo "2. make plan ã§ãƒ—ãƒ©ãƒ³ã‚’ç¢ºèª"
	@echo "3. make apply ã§ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆ"

# å…¨ä½“ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
import-all: import-apis import-service-accounts import-cloud-sql import-cloud-sql-database import-cloud-run import-cloud-run-job import-secret import-artifact-registry ## å…¨ã¦ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ